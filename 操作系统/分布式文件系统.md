#### **分布式文件系统**

---

1.  [分布式系统基本概念](# 分布式系统基本概念)
2.  [分布式系统的实现以及基本要求](# 分布式系统的实现以及基本要求)
3.  [命名和共享语义](# 命名和共享语义)
4.  [远程文件访问和缓存](# 远程文件访问和缓存)
5.  [容错](# 容错)

---

#### 分布式系统基本概念

1.  分布式系统定义

   ```markdown
   分布式系统是基于软件实现的一种多处理机系统。是多个处理机通过通信线路互连构成的松散耦合系统。系统的处理和控制在各个处理机上。换言之，是利用软件系统方式构建在计算机网络上的一种多处理机系统。
   ```

   分布式系统与一般多处理机系统的不同:

   +  分布式系统每个节点都会一台独立的计算机，并配置有外部设备。
   +  分布式系统耦合度更加分散，地理分布区域更加广阔。
   +  分布式系统中每个节点都可以运行不同操作系统，每个节点拥有自己的文件系统。处理本节点的管理外，还对其他多个机构进行实施管理。

2.  分布式系统特征

   +  分布性

     系统由多台计算机组成，从位置和地域范围而言。是分散且广阔的，即地理位置的分布性。从系统功能上来看，分散在系统的各个节点上，即功能分布性。从系统资源来说，分布在各个节点计算机上，为资源分布性。从控制上来说，一般分布式系统没有主从之分，即控制分布性。

   +  透明性

     系统资源被所有计算机共享，每台计算机的用户不仅可以使用本机资源，还可以使用获取分布式系统中其他计算机资源(CPU,文件，打印)

   +  同一性

     系统中若干计算机可以互相协作完成一个共同任务。或者说一个程序可以分布在几台计算机上并行执行。

   +  全局性

     系统具备一个全局性的进程通信机制，系统中任意两台计算机都可以通过该机制实现信息交换。

3.  分布式系统优点

   +  计算能力强    采用了并行处理技术，将任务划分为多个子任务，并将子任务分派到不同的计算机系统上。
   +  易于实现共享  分布式系统建立在计算机网络上，对于系统资源，很容易实现共享。
   +  方便通信  各节点通过通信网络链接，建立在计算机网络基础上
   +  可靠性高  单机故障不会影响到其他机器
   +  可扩充性好  分布式系统中可以方便的添加若干节点，而不用修改系统软硬件

4.  分布式操作系统与单机操作系统的不同

   +  通信管理系统

     分布式OS应当提供某种通信方式，使得不同节点上的用户或进程能方便的进行信息交换。一般的，分布式OS通过通信原语方式，实现系统内部进程通信，但是由于系统没有共享内存。需要按照通信协议的约定和规则实现。

   +  资源管理功能

     分布式OS对所有资源提供统一资源管理，统一资源分配和统一调度。

   +  进程管理功能

     针对系统分布性特征，为平衡各个节点负载，加速计算速度。分布式OS应当提供**进程或者计算迁移**。为协调进程对资源的共享和竞争，提高进程的并行程度，应当提供分布式的同步和互斥机制，以应对**死锁**措施。

#### 分布式系统实现以及基本要求

1.  DFS实现方式

   +  共享文件系统方式

     这种方式称作**专用服务器**方式，类似于本地文件系统使用树形目录结构。管理本地计算机存储设备上的文件方式。共享文件系统方式也采用了一个逻辑树结构，对整个系统中的文件系统进行管理(B+树)。系统采取客户端服务器模式，设置若干个文件服务器。数据分布地存储在各个文件服务器上。用户可以忽略文件的实际物理地址位置,只需要一定的逻辑关系。通过文件服务器上的服务进程，即可访问整个系统的共享资源。文件服务器的分布和逻辑树架构，对于用户都是透明的。用户既可以向访问本地文件一样访问分布在多个节点的文件。

     这种实现方式比较简单，对于设备要求不高，通用性高。使用的例子有NFS,AFS和Sprite文件系统。

   +  共享磁盘方式

     这种范式也称作无服务方式，在这种方式下，系统没有专门的文件服务器。而是配置了一个共享磁盘(高速磁盘,IBM SSA).并将其与主机，客户机连接在内部高速网络上，主机和客户机都将共享磁盘作为存储设备。直接以盘块的方式读写磁盘上文件，实现共享。

     该方式对设备要求高，需要高端存储设备(NAS,SAN)。使用该方案的有IBM GPFS,GFS等

2.  基本要求

   +  透明性要求

     1.  位置透明性

        文件服务器及文件服务进程的多重性。与共享存储器的分散性，对客户透明。

     2.  移动透明性

        存储资源和时间在系统内位置移动和改变对于客户透明

     3.  性能透明性

        允许系统中服务负载有一定的变化量，仍能满足客户的性能保障

     4.  扩展透明性   

        允许系统在规模，性能和功能上进行扩展，以满足负载和网络规模增长

   +  高性能和高可靠性

   +  容错性

     一般采用冗余措施来对故障进行掩盖

     1.  信息冗余   增加校验信息
     2.  时间冗余   重复执行操作
     3.  物理冗余  增加额外的副本，设备或者进程

   +  安全性

     通过身份认证，访问控制和安全通道方式，保证系统安全性

   +  一致性

     保证客户本地缓存文件副本与文件服务器上主副本一致

#### 命名和共享语义

1.  命名

   命名主要采用如下三种方案:

   +  结合**主机名**和**本地名**对文件命名

     保证系统范围内的唯一性，简单易行，但是不符合命名的透明性

   +  若干服务器中的远程目录，添加到用户本地目录

     管理复杂度高，结构混乱，安全度低,一旦一个服务器故障，会导致客户机上目录失效。

   +  全局同一命名

     考虑到不同系统中的特殊文件，使得方案实现难度较大

2. 共享语义

   对于DFS来说，需要保证多个客户端并发访问时的数据一致性，因此，**当多个客户共享一个文件时，必须对客户机和服务器直接的交互协议精确处理**，精确定义读和写的语义。

   例如，服务器上有一个文件的主副本，客户机A因为频繁使用的原因。在本地高速缓存中也保留了一份文件副本。某一时刻，客户机A得到的文件对高速缓存的文件副本进行了修改。此时B从服务器中读取了这个文件，显然B拿到的是一个过时的文件，可见语言定义出现了问题。

   为了保持文件在客户机本地缓存中的副本和服务器上的副本一致性。将上述语义修改为: 客户端A对本地高速缓存的修改必须立即传回服务器.虽然表面上解决了一致性问题,但是实际上,因为没有界定修改的截止点.这种方式非常低效.

   另一种语义修改为: 只有当客户机A对文件修改完毕.执行关闭操作后,才将修改后的副本上传到服务器,并通知客户端B.这样B就可以获得正确的文件.

   有上述可知,共享语义决定了多个客户的共享文件效果,是评价DFS允许多个客户共享文件的重要标准.特别是,这些语义应当说明被客户修改的数据何时可以被远程客户端看到.

   通常共享文件语义主要有4类:

   1.  UNIX语义

      文件的每个操作对于所有进程来说都是瞬间可见的.

   2.  会话语义

      在文件关闭之前,所有改动对其进程都是不可见的

   3.  不允许更新语义

      不能进行更改,只能进行简单的共享和复制

   4.  事务处理

      所有改动以原子操作的方式发生

3. 租赁协议

   租赁协议时一个比较具有代表性的一致性访问协定.

   当客户机向服务器发送一个读请求时,不仅受到所请求的数据,还会收到一个租赁数据.给凭据附带一个有效期,保证服务器在该有效期内不会对一个客户机收到的数据进行更新.

   如果客户端在本地高速缓存中保有了副本,在有效期内,客户机对数据的访问只需要在本地缓存内进行.不必重新请求服务器,数据也不会重新发送.

   只有当租赁协议超过有效期时,客户端才会和服务器进行交互,确定本地缓存中数据是否与服务器上的一致.判断服务器上的数据是否进行了更新,只有确认发生了更新,才会想服务器提出请求,获取最新的服务数据.

   作为服务器,当客户机对数据发出的更新请求时,并不是立即进行更新,而是想所有持有该文件的租赁客户机发出更新确认.所有客户机收到服务器发送的更新确认时,即将持有的租赁凭据标记为无效.此后,客户机需要再次访问该数据,必须重新向服务器请求.在获取新数据同时,获取一张新的租赁凭证.

   租赁协议是一个多读者单写者机制,即同一个世界同一文件可以允许多个客户机进行操作.但是队友客户机的写操作,同一时间只允许一个客户机进行,进行读写操作的客户机只能进行互斥进行.

#### 远程文件访问和缓存

DFS系统中,需要解决的另一个问题就是远程文件的访问.在CS模式下,客户端使用远程服务机制访问文件.访问请求被送到服务器时.服务器执行访问,并将结果返回给客户.执行远程服务调用最常用的就是RPC.

考虑到客户一般情况下,对数据有反复使用的情况,根据程序的局部性原理.所以在DFS系统中引入了缓存机制.通常获取的数据比实际使用的数据多的多.(例如整个文件或几个页面).之所以随后的访问,客户机可以在本地进行副本中进行.

1.  缓存和远程服务比较

   +  使用缓存时,大量的远程访问,会被转化为本地访问,获得本地服务的访问速度
   +  使用缓存时,服务器负载和网络通信量都减少了,扩充能力加强.
   +  缓存时,网络总开销要地域远程服务
   +  缓存的主要缺陷时一致性问题,针对不常写入的模式中,使用缓存是具有优势的.但是对于经常写入的情况下,用于解决一致性问题反而导致在性能,网络通信量,服务器负载方面大量开销.
   +  使用缓存作为远程访问方法系统中,仿真集中式系统的共享语义时困难的.使用远程服务是,服务器将所有访问串行化.能够实现任何集中的共享定义.
   +  机器建接口不同,远程服务仅仅是本地文件系统接口在网络上的扩展.机器的接口就是本地和文件系统之间的接口.缓存方式中,数据是在服务器和客户端之间的整体传输.

2.  缓存的粒度和位置

   +  缓存粒度

     DFS系统中,缓存粒度(基本单元)可以是文件的若干块.也可以是若干个文件.甚至可以是整个文件系统.

     缓存粒度越大,存储的数据就越多.可以增加访问速度,减少通信浏览,降低服务器的负载.但是一次性传输开销增大.另一个方面,频繁写的情况下,花费在保持数据一致性的开销也增大了.

     反之粒度太小,降低了缓存命中率,增加了通信开销,加大了服务器负载,降低了客户机访问速度.

     同时,缓存中,存储块的大小划分也会影响到缓存的性能.可见缓存大小以及存储块大小对缓存性能有影响.

   +  缓存位置

     使用磁盘做缓存,具有可靠性高的优势.使用主存做缓存,存取速度快.

     1.  服务器磁盘
     2.  服务器主存
     3.  客户机磁盘
     4.  客户机主存

3.  缓存的更新

   +  直接写缓存   

     一旦数据写到缓存器,就把数据写到服务器磁盘,可靠性高

   +  延时写缓存

     修改先写到缓存中,等待一段时间,在将其写到服务磁盘上,但这样语义可能不清晰

   +  驱逐式写缓存

     当被修改的数据块将被从缓存中换出时,将数据块发送的服务器上

   +  周期性写缓存

     周期性的扫描缓存,把上次扫描以来已经被修改的数据发送给服务器

   +  关闭时写缓存

     文件关闭时写数据到服务器,与会话语义对应.

4.  数据一致性

   对于本地缓存的数据副本和服务器中的主副本.客户机需要进行有效性检查,判断它是否一致之后才能使用,如果不一致,则表明本地缓存数据已经过时,这些数据就不能给客户机提供访问服务.需要进行更新.对于这样的检查

   +  客户端发起

     客户机与服务器联系,检查本地数据和服务器上的主副本是否一致.这个方法关键是这种有效性检查的频度范围,既可以设置每访问一次进行,待只对文件的第一次打开进行.也可以按固定时间间隔周期进行.检查频率高低直接影响到网络和服务器负载.

   +  服务器发起

     服务器为每个客户机记录缓存文件,当服务检查出结果可能不一致时,就必须进行处理.如果检测到一个文件在多个客户机竞争状态中打开时,服务器使该缓存失效.该方法的问题在于违背了CS模式.

#### 容错

1.  无状态服务和有状态服务

   +  有状态服务

     一个服务器对某个客户机进提供数据服务,缓存了客户机有关信息,该服务器称作有状态服务器

   +  无状态服务

     服务器对某个客户机提供数据服务时,没有缓存该客户机的有关信息,称作无状态服务

2.  容错性

   +  可恢复性当文件操作失败时，或者有客户终止操作时，如果我呢间转换到原来一直状态，说明文件是可恢复的。

   +  坚定性

     当某个存储器崩溃或者存储介质损坏时某个文件能保证完好。说明文件是坚定的。

   +  可用性

     无论何时，只要需要就可以进行访问。在某个机器或者存储器崩溃时仍然可以访问，称作文件为可用的。

3.  可用性和文件复制

   文件复制时保证可用性的冗余措施，这里指的是DFS系统中节点的主机磁盘复制。