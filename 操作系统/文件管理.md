### **文件管理**

---

1.  [文件和文件系统](# 文件和文件系统)
2.  [文件的逻辑结构](# 文件和文件系统)
3.  [外存分配方式](# 外存分配方式)
4.  [目录管理](# 目录管理)
5.  [文件存储空间的管理](# 文件存储空间的管理)
6.  [文件共享和文件保护](# 文件共享和文件保护)
7.  [数据一致性控制](# 数据一致性控制)

---

#### 文件和文件系统

1.  文件，记录和数据项

   +  数据项

     1.  基本数据项:

        用于描述对象某种属性的字符集，是数据组织中可以命名的最小逻辑单位，即**原子数据**，又称**数据元素**或者**字段**。命名往往与其属性一致。

        例如，用于描述一个学生的基本数据项有： 学号、 姓名、 年龄、 所在班级等。

     2.  组合数据项:

        若是有若干个基本数据项组成，简称组项。

        例如，经理便是个组项，它由正经理和副经理两个基本项组成。又如，工资也是个组项，它可由基本工资、工龄工资和奖励工资等基本项所组成。

        基本数据项除了数据名外，还应该有数据类型。因为基本项仅是描述某个对象的属性，根据属性的不同，需要用不同的数据类型来描述。

        例如，在描述学生的学号时，应使用整数； 描述学生的姓名则应使用字符串(含汉字)；描述性别时，可用逻辑变量或汉字。

        可见，由数据项的名字和类型两者共同定义了一个数据项的“型”。而表征一个实体在数据项上的数据则称为“值”。例如，学号/30211、姓名/王有年、性别/男等。 

   +  记录

     记录时一组相关数据项的集合，用于描述一个对象在某方面的属性。一个记录应该包含哪些数据项，取决于描述对象的哪个方面。

     例如，一个学生，当把他作为班上的一名学生时，对他的描述应使用学号、姓名、年龄及所在系班，也可能还包括他所学过的课程的名称、 成绩等数据项。

     但若把学生作为一个医疗对象时，对他描述的数据项则应使用诸如病历号、 姓名、 性别、
     出生年月、 身高、 体重、 血压及病史等项。

   +  文件

     文件是由创建者定义，具有文件名的一组相关元素集合，可分为有结构文件和无结构文件两种。有结构文件中，文件由若干个相关记录组成。无结构文件则被看做成一个**字符流**。

     文件时文件系统中最大的数据单位，描述了一个对象集。例如，可以将一个班的学生记录作为一个文件。

     一个文件必须要有一个文件名称，通常是由ASCII吗组成，名称长度因系统而异。有的系统名字规定为8个字符，有的系统规定为14个字符。

     属性可以包括:

     1.  文件类型
     2.  文件长度
     3.  文件物理位置
     4.  文件建立时间

2.  文件类型和文件系统模型

   1.  文件类型

      +  文件类型
        1.  按用途分类
           +  系统文件
           +  用户文件
           +  库文件
        2.  按文件中数据形式分类
           +  源文件
           +  目标文件
           +  可执行文件
        3.  按存取控制属性分类
           + 只执行文件
           + 只读文件
           + 读写文件

   2.  文件系统模型

      +  对象及其属性

        文件管理系统管理对象有

        1.  文件

           作为文件管理的直接对象

        2.  目录

           为了方便对文件的存取和检索，在文件系统中必须配置目录。对目录的组织和管理是方便用户和提高对文件存取速度的关键。

        3.  磁盘存储空间

           文件和目录必定占用存储空间，对这部分空间的有效管理，不仅能提高外存利用率，而且能够提高对文件的存取速度。

      +  对对象操作和管理的软件集合

        ​	是文件管理系统核心部分。文件系统功能大多数是在这一层实现的，其中包括: 对文件存储空间的管理，对文件目录的管理，将文件逻辑地址转化为物理地址机制，对文件的读写管理，对文件共享和保护功能。

      +  文件系统接口

        ​	为了方便用户使用文件系统，文件系统通常向用户提供两种类型接口:

        1.  命令接口

           作为用户和文件系统交互的接口。用户可通过键盘终端键入命令，取得文件系统服务。

        2.  程序接口

           用户程序和文件系统的接口。用户程序可通过系统调用取得文件系统服务。

   3.  文件操作

      +  文件操作类型

        1.  创建文件
        2.  删除文件
        3.  读文件
        4.  写文件
        5.  截断文件
        6.  设置文件读写位置

      +  文件的打开和关闭操作

        是指系统将指定文件的属性(包括文件在外存上的物理位置)从外存拷贝到内存，打开文件表中的一个表目，并将表目编号(**索引**)返回给用户。以后，当用户再要求对文件的相应操作时，便可以直接利用该索引号到**打开文件表**中去寻找，避免了对文件的再次检索。节省了大量检索开销，显著的提高了对文件的操作速度，如果用户已经不再需要对文件实施相应的操作，可以利用**关闭**来关闭此文件，OS会将该文件从**打开文件表**的表目上删除掉。

      +  其他文件操作

        为了方便用户使用文件，通常，OS提供数条有关文件操作的系统调用。可以将这些调用分为若干类: 

        1.  对文件属性进行操作

           运行用户直接设置和获取文件属性(文件名，文件拥有者，文件访问权)

        2.  对目录的相关操作

           创建一个目录，删除一个目录，改变当前目录和工作目录。

        3.  实现文件共享的系统调用以及对文件系统进行操作的系统调用

#### 文件的逻辑结构

对于任何一种文件，都存在一下两种形式的结构:

+  文件的逻辑结构
+  文件的物理结构(又称文件的存储结构，是指文件在外存上存储的组织形式)

1.  文件逻辑结构的类型

   +  有结构文件

     对于记录

     1.  定长记录
     2.  变长记录

     对于文件

     1.  顺序文件
     2.  索引文件
     3.  索引顺序文件

   +  无结构文件

     大量的数据结构和数据库可以采用有结构的文件形式，大量的源程序，可执行文件，库函数采用的就是无结构文件形式，即流式文件。对于流式文件的访问，采取读写指针的方式来指明下一个需要访问的字符，可以把流式文件看作是记录式文件的一个特例。

2.  顺序文件

   +  逻辑记录的排序

     1.  串结构：各记录之间的顺序与关键字无关。通常办法时由时间决定，按存入时间先后排列。
     2.  顺序结构：文件中所有记录按照关键字(词)排列，可以按照关键字长短排序，也可以按照字典顺序排序。

   +  对顺序文件的读写操作

     对于定长/变长记录文件的读写

     <img src="E:\截图文件\顺序文件的读写操作.png" style="zoom:67%;" />

   +  顺序文件的优缺点

     +  优势

       顺序文件的最佳应用场合，是在对诸记录进行批量存取时，即每次要读或写一大批记录。此时，对顺序文件的存取效率是所有逻辑文件中最高的；此外，也只有顺序文件才能存储在磁带上， 并能有效地工作。

     +  缺点

       在交互应用的场合，如果用户(程序)要求查找或修改单个记录，为此系统便要去逐个地查找诸记录。这时， 顺序文件所表现出来的性能就可能很差， 尤其是当文件较大时， 情况更为严重。 例如，有一个含有104个记录的顺序文件，如果对它采用顺序查找法去查找一个指定的记录，则平均需要查找5×103个记录；如果是可变长记录的顺序文件，则为查找一个记录所需付出的开销将更大，这就限制了顺序文件的长度。 

       顺序文件的另一个缺点是，如果想增加或者删除一个记录时比较困难，为了解决这个问题。为顺序文件配置了一个**记录文件**(Log File)或称作**事务文件**(Transaction File).它们的作用是，将试图增加，删除或者修改信息的记录于其中，规定每隔一段时间，例如4小时，将允许记录文件和原来主文件进行合并，产生一个按照关键字排序的新文件。

3.  索引文件

   对于定长记录文件，如果需要查找第i个记录，直接可以根据首记录地址计算出其首地址

   ​	Ai = A0 + i * L

   对于变长记录文件，计算这个地址时，需要对前面i-1的记录顺序查找，即

   ​	Ai =sigma(0,i-1,Li) +A0

   从中可以获取前i-1个首地址信息，记录下来，形成**索引表**

   <img src="E:\截图文件\索引表.png" style="zoom:67%;" />

4.  索引顺序文件

   索引顺序表的结构组织

   <img src="E:\截图文件\索引顺序表的结构组织.png" style="zoom:67%;" />

5.  直接哈希和哈希文件

   +  直接文件

     直接文件，可以根据给定的记录键值信息，直接获得指定记录的物理地址。换言之，记录键值本身就决定了物理地址。有记录键值到记录物理地址的转换称作**键值转换**。组织直接文件的关键点在于使用设么方法映射记录值到物理地址之间的转换。

   +  Hash文件的寻址

     <img src="E:\截图文件\Hash文件寻址.png" style="zoom:67%;" />

#### 外存分配方式

1.  连续分配

   +  连续分配图示

     <img src="E:\截图文件\连续分配.png" style="zoom:67%;" />

   +  连续分配优缺点

     1.  优点:

        顺序访问容易且速度快

     2. 缺点

        + 要求有连续的存储空间

        + 必须事先知道文件的长度才可以分配

2.  链接分配

   +  隐式链接(记录内部存在链接)

     <img src="E:\截图文件\隐式链接.png" style="zoom:67%;" />

   +  显式链接(直接指向文件物理地址)

     <img src="E:\截图文件\显式链接.png" style="zoom:67%;" />

3.  索引分配

   +  单级索引地址

     链接分配方式解决了连续分配方式存在的问题,但是出现了两个问题:

     1.  不能支持高效的直接存取,要对一个较大的文件进行直接存取,需要首先在FAT中顺序查找很多盘块号.

     2.  FAT 占用较大的内存空间

        <img src="E:\截图文件\单级索引地址.png" style="zoom:67%;" />

   +  多级索引地址(支持更多的文件索引)

     <img src="E:\截图文件\多级文件索引.png" style="zoom:67%;" />

   +  混合索引

     <img src="E:\截图文件\混合索引.png" style="zoom:67%;" />
     +  直接地址

       为了提高文件检索速度,索引节点中设置10个直接地址项.即使用iaddr(0) - iaddr(9)存放直接地址。换言之，在每项中存放的是该文件数据的盘块的盘块号。假设每个盘块的大小为4 KB，房文件大小不大于40KB时，可以使用索引节点读取所有的盘块号。

     +  一次间接地址

       对于大中型文件，直接采用直接地址时不现实的。为此可以利用索引节点中地址向iaddr(10)提供一次间接地址。这种方式实质就是一级索引分配方式。(实质就是一级索引分配方式)

     +  多次间接地址

       当文件长度大于4MB + 40 KB时系统还需要采用二次间接地址分配，使用地址项iaddr(11)分配，这种情况下最大分配4GB，三级间接寻址运行文件最大长度4TB。

#### 目录管理

+ 目录管理的要求如下:

1.  实现按名存取
2.  提高对目录的检索速度
3.  文件共享
4.  允许文件重名

+ 文件控制块(FCB)和索引结点

  1.  基本信息类

     +  文件名
     +  文件物理位置
     +  文件逻辑结构
     +  文件物理结构

  2.  存储控制信息类

  3.  使用信息类

     文件名 + 扩展名 + 属性 + 备用 + 时间 + 日期 + 第一块号 + 盘块数

+ 索引结点

  1.  索引节点引入
  2.  磁盘索引结点
     + 文件主标识符
     +  文件类型
     +  文件存取权限
     +  文件物理地址
     +  文件长度
     +  文件连接次数
     +  文件存取时间
  3.  内存索引结点
     +  索引结点编号 用于标识内存索引结点
     +  状态 结点i是否被上锁，或者是被修改
     +  访问此时   节点被访问次数
     +  文件所属文件系统的逻辑设备号
     +  链接指针    设置有指向空闲链表和散列队列的指针

+  目录结构

  1.  单级目录结构、

     单级目录结构支持按名存取，但是:

     +  查找速度慢
     +  不允许重名
     +  不便于实现文件共享

     <img src="E:\截图文件\单级目录结构.png" style="zoom:67%;" />

  2.  两级目录

     +  提高目录检索速度
     +  在不同用户目录中可以存着相同文件名
     +  不同用户可以使用不同文件名称来访问系统中同一个共享文件

     <img src="E:\截图文件\两级目录结构.png" style="zoom:67%;" />

  3.  多机目录结构

     +  目录结构

       <img src="E:\截图文件\多级目录结构.png" style="zoom:67%;" />

     +  路径名称

       在树形目录结构中， 从根目录到任何数据文件， 都只有一条惟一的通路。在该路径上从树的根(即主目录)开始，把全部目录文件名与数据文件名，依次地用“/”连接起来，即构成该数据文件的路径名(path name)。系统中的每一个文件都有惟一的路径名。 

     +  当前目录

  4.  增加和删除目录

     +  不删除非空目录

       当目录(文件)不空时，不能将其删除，而为了删除一个非空目录，必须先删除目录中的所有文件，使之先成为空目录，后再予以删除。如果目录中还包含有子目录，还必须采取递归调用方式来将其删除， 在MS-DOS中就是采用这种删除方式。

     +  可删除非空目录

       当要删除一目录时，如果在该目录中还包含有文件，则目录中的所有文件和子目录也同时被删除。

#### 文件存储空间的管理

#### 文件共享和文件保护

#### 数据一致性控制

