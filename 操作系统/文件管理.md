### **文件管理**

---

1.  [文件和文件系统](# 文件和文件系统)
2.  [文件的逻辑结构](# 文件和文件系统)
3.  [外存分配方式](# 外存分配方式)
4.  [目录管理](# 目录管理)
5.  [文件存储空间的管理](# 文件存储空间的管理)
6.  [文件共享和文件保护](# 文件共享和文件保护)
7.  [数据一致性控制](# 数据一致性控制)

---

#### 文件和文件系统

1.  文件，记录和数据项

   +  数据项

     1.  基本数据项:

        用于描述对象某种属性的字符集，是数据组织中可以命名的最小逻辑单位，即**原子数据**，又称**数据元素**或者**字段**。命名往往与其属性一致。

        例如，用于描述一个学生的基本数据项有： 学号、 姓名、 年龄、 所在班级等。

     2.  组合数据项:

        若是有若干个基本数据项组成，简称组项。

        例如，经理便是个组项，它由正经理和副经理两个基本项组成。又如，工资也是个组项，它可由基本工资、工龄工资和奖励工资等基本项所组成。

        基本数据项除了数据名外，还应该有数据类型。因为基本项仅是描述某个对象的属性，根据属性的不同，需要用不同的数据类型来描述。

        例如，在描述学生的学号时，应使用整数； 描述学生的姓名则应使用字符串(含汉字)；描述性别时，可用逻辑变量或汉字。

        可见，由数据项的名字和类型两者共同定义了一个数据项的“型”。而表征一个实体在数据项上的数据则称为“值”。例如，学号/30211、姓名/王有年、性别/男等。 

   +  记录

     记录时一组相关数据项的集合，用于描述一个对象在某方面的属性。一个记录应该包含哪些数据项，取决于描述对象的哪个方面。

     例如，一个学生，当把他作为班上的一名学生时，对他的描述应使用学号、姓名、年龄及所在系班，也可能还包括他所学过的课程的名称、 成绩等数据项。

     但若把学生作为一个医疗对象时，对他描述的数据项则应使用诸如病历号、 姓名、 性别、
     出生年月、 身高、 体重、 血压及病史等项。

   +  文件

     文件是由创建者定义，具有文件名的一组相关元素集合，可分为有结构文件和无结构文件两种。有结构文件中，文件由若干个相关记录组成。无结构文件则被看做成一个**字符流**。

     文件时文件系统中最大的数据单位，描述了一个对象集。例如，可以将一个班的学生记录作为一个文件。

     一个文件必须要有一个文件名称，通常是由ASCII吗组成，名称长度因系统而异。有的系统名字规定为8个字符，有的系统规定为14个字符。

     属性可以包括:

     1.  文件类型
     2.  文件长度
     3.  文件物理位置
     4.  文件建立时间

2.  文件类型和文件系统模型

   1.  文件类型

      +  文件类型
        1.  按用途分类
           +  系统文件
           +  用户文件
           +  库文件
        2.  按文件中数据形式分类
           +  源文件
           +  目标文件
           +  可执行文件
        3.  按存取控制属性分类
           + 只执行文件
           + 只读文件
           + 读写文件

   2.  文件系统模型

      +  对象及其属性

        文件管理系统管理对象有

        1.  文件

           作为文件管理的直接对象

        2.  目录

           为了方便对文件的存取和检索，在文件系统中必须配置目录。对目录的组织和管理是方便用户和提高对文件存取速度的关键。

        3.  磁盘存储空间

           文件和目录必定占用存储空间，对这部分空间的有效管理，不仅能提高外存利用率，而且能够提高对文件的存取速度。

      +  对对象操作和管理的软件集合

        ​	是文件管理系统核心部分。文件系统功能大多数是在这一层实现的，其中包括: 对文件存储空间的管理，对文件目录的管理，将文件逻辑地址转化为物理地址机制，对文件的读写管理，对文件共享和保护功能。

      +  文件系统接口

        ​	为了方便用户使用文件系统，文件系统通常向用户提供两种类型接口:

        1.  命令接口

           作为用户和文件系统交互的接口。用户可通过键盘终端键入命令，取得文件系统服务。

        2.  程序接口

           用户程序和文件系统的接口。用户程序可通过系统调用取得文件系统服务。

   3.  文件操作

      +  文件操作类型

        1.  创建文件
        2.  删除文件
        3.  读文件
        4.  写文件
        5.  截断文件
        6.  设置文件读写位置

      +  文件的打开和关闭操作

        是指系统将指定文件的属性(包括文件在外存上的物理位置)从外存拷贝到内存，打开文件表中的一个表目，并将表目编号(**索引**)返回给用户。以后，当用户再要求对文件的相应操作时，便可以直接利用该索引号到**打开文件表**中去寻找，避免了对文件的再次检索。节省了大量检索开销，显著的提高了对文件的操作速度，如果用户已经不再需要对文件实施相应的操作，可以利用**关闭**来关闭此文件，OS会将该文件从**打开文件表**的表目上删除掉。

      +  其他文件操作

        为了方便用户使用文件，通常，OS提供数条有关文件操作的系统调用。可以将这些调用分为若干类: 

        1.  对文件属性进行操作

           运行用户直接设置和获取文件属性(文件名，文件拥有者，文件访问权)

        2.  对目录的相关操作

           创建一个目录，删除一个目录，改变当前目录和工作目录。

        3.  实现文件共享的系统调用以及对文件系统进行操作的系统调用

#### 文件的逻辑结构

对于任何一种文件，都存在一下两种形式的结构:

+  文件的逻辑结构
+  文件的物理结构(又称文件的存储结构，是指文件在外存上存储的组织形式)

1.  文件逻辑结构的类型

   +  有结构文件

     对于记录

     1.  定长记录
     2.  变长记录

     对于文件

     1.  顺序文件
     2.  索引文件
     3.  索引顺序文件

   +  无结构文件

     大量的数据结构和数据库可以采用有结构的文件形式，大量的源程序，可执行文件，库函数采用的就是无结构文件形式，即流式文件。对于流式文件的访问，采取读写指针的方式来指明下一个需要访问的字符，可以把流式文件看作是记录式文件的一个特例。

2.  顺序文件

   +  逻辑记录的排序

     1.  串结构：各记录之间的顺序与关键字无关。通常办法时由时间决定，按存入时间先后排列。
     2.  顺序结构：文件中所有记录按照关键字(词)排列，可以按照关键字长短排序，也可以按照字典顺序排序。

   +  对顺序文件的读写操作

     对于定长/变长记录文件的读写

     <img src="E:\截图文件\顺序文件的读写操作.png" style="zoom:67%;" />

   +  顺序文件的优缺点

     +  优势

       顺序文件的最佳应用场合，是在对诸记录进行批量存取时，即每次要读或写一大批记录。此时，对顺序文件的存取效率是所有逻辑文件中最高的；此外，也只有顺序文件才能存储在磁带上， 并能有效地工作。

     +  缺点

       在交互应用的场合，如果用户(程序)要求查找或修改单个记录，为此系统便要去逐个地查找诸记录。这时， 顺序文件所表现出来的性能就可能很差， 尤其是当文件较大时， 情况更为严重。 例如，有一个含有104个记录的顺序文件，如果对它采用顺序查找法去查找一个指定的记录，则平均需要查找5×103个记录；如果是可变长记录的顺序文件，则为查找一个记录所需付出的开销将更大，这就限制了顺序文件的长度。 

       顺序文件的另一个缺点是，如果想增加或者删除一个记录时比较困难，为了解决这个问题。为顺序文件配置了一个**记录文件**(Log File)或称作**事务文件**(Transaction File).它们的作用是，将试图增加，删除或者修改信息的记录于其中，规定每隔一段时间，例如4小时，将允许记录文件和原来主文件进行合并，产生一个按照关键字排序的新文件。

3.  索引文件

   对于定长记录文件，如果需要查找第i个记录，直接可以根据首记录地址计算出其首地址

   ​	Ai = A0 + i * L

   对于变长记录文件，计算这个地址时，需要对前面i-1的记录顺序查找，即

   ​	Ai =sigma(0,i-1,Li) +A0

   从中可以获取前i-1个首地址信息，记录下来，形成**索引表**

   <img src="E:\截图文件\索引表.png" style="zoom:67%;" />

4.  索引顺序文件

   索引顺序表的结构组织

   <img src="E:\截图文件\索引顺序表的结构组织.png" style="zoom:67%;" />

5.  直接哈希和哈希文件

   +  直接文件

     直接文件，可以根据给定的记录键值信息，直接获得指定记录的物理地址。换言之，记录键值本身就决定了物理地址。有记录键值到记录物理地址的转换称作**键值转换**。组织直接文件的关键点在于使用设么方法映射记录值到物理地址之间的转换。

   +  Hash文件的寻址

     <img src="E:\截图文件\Hash文件寻址.png" style="zoom:67%;" />

#### 外存分配方式

1.  连续分配

   +  连续分配图示

     <img src="E:\截图文件\连续分配.png" style="zoom:67%;" />

   +  连续分配优缺点

     1.  优点:

        顺序访问容易且速度快

     2. 缺点

        + 要求有连续的存储空间

        + 必须事先知道文件的长度才可以分配

2.  链接分配

   +  隐式链接(记录内部存在链接)

     <img src="E:\截图文件\隐式链接.png" style="zoom:67%;" />

   +  显式链接(直接指向文件物理地址)

     <img src="E:\截图文件\显式链接.png" style="zoom:67%;" />

3.  索引分配

   +  单级索引地址

     链接分配方式解决了连续分配方式存在的问题,但是出现了两个问题:

     1.  不能支持高效的直接存取,要对一个较大的文件进行直接存取,需要首先在FAT中顺序查找很多盘块号.

     2.  FAT 占用较大的内存空间

        <img src="E:\截图文件\单级索引地址.png" style="zoom:67%;" />

   +  多级索引地址(支持更多的文件索引)

     <img src="E:\截图文件\多级文件索引.png" style="zoom:67%;" />

   +  混合索引

     <img src="E:\截图文件\混合索引.png" style="zoom:67%;" />
     +  直接地址

       为了提高文件检索速度,索引节点中设置10个直接地址项.即使用iaddr(0) - iaddr(9)存放直接地址。换言之，在每项中存放的是该文件数据的盘块的盘块号。假设每个盘块的大小为4 KB，房文件大小不大于40KB时，可以使用索引节点读取所有的盘块号。

     +  一次间接地址

       对于大中型文件，直接采用直接地址时不现实的。为此可以利用索引节点中地址向iaddr(10)提供一次间接地址。这种方式实质就是一级索引分配方式。(实质就是一级索引分配方式)

     +  多次间接地址

       当文件长度大于4MB + 40 KB时系统还需要采用二次间接地址分配，使用地址项iaddr(11)分配，这种情况下最大分配4GB，三级间接寻址运行文件最大长度4TB。

#### 目录管理

+ 目录管理的要求如下:

1.  实现按名存取
2.  提高对目录的检索速度
3.  文件共享
4.  允许文件重名

+ 文件控制块(FCB)和索引结点

  1.  基本信息类

     +  文件名
     +  文件物理位置
     +  文件逻辑结构
     +  文件物理结构

  2.  存储控制信息类

  3.  使用信息类

     文件名 + 扩展名 + 属性 + 备用 + 时间 + 日期 + 第一块号 + 盘块数

+ 索引结点

  1.  索引节点引入
  2.  磁盘索引结点
     + 文件主标识符
     +  文件类型
     +  文件存取权限
     +  文件物理地址
     +  文件长度
     +  文件连接次数
     +  文件存取时间
  3.  内存索引结点
     +  索引结点编号 用于标识内存索引结点
     +  状态 结点i是否被上锁，或者是被修改
     +  访问此时   节点被访问次数
     +  文件所属文件系统的逻辑设备号
     +  链接指针    设置有指向空闲链表和散列队列的指针

+  目录结构

  1.  单级目录结构、

     单级目录结构支持按名存取，但是:

     +  查找速度慢
     +  不允许重名
     +  不便于实现文件共享

     <img src="E:\截图文件\单级目录结构.png" style="zoom:67%;" />

  2.  两级目录

     +  提高目录检索速度
     +  在不同用户目录中可以存着相同文件名
     +  不同用户可以使用不同文件名称来访问系统中同一个共享文件

     <img src="E:\截图文件\两级目录结构.png" style="zoom:67%;" />

  3.  多机目录结构

     +  目录结构

       <img src="E:\截图文件\多级目录结构.png" style="zoom:67%;" />

     +  路径名称

       在树形目录结构中， 从根目录到任何数据文件， 都只有一条惟一的通路。在该路径上从树的根(即主目录)开始，把全部目录文件名与数据文件名，依次地用“/”连接起来，即构成该数据文件的路径名(path name)。系统中的每一个文件都有惟一的路径名。 

     +  当前目录

  4.  增加和删除目录

     +  不删除非空目录

       当目录(文件)不空时，不能将其删除，而为了删除一个非空目录，必须先删除目录中的所有文件，使之先成为空目录，后再予以删除。如果目录中还包含有子目录，还必须采取递归调用方式来将其删除， 在MS-DOS中就是采用这种删除方式。

     +  可删除非空目录

       当要删除一目录时，如果在该目录中还包含有文件，则目录中的所有文件和子目录也同时被删除。
     
  5.   目录查询技术
  
      +  线性检索法(使用线性检索法检索盘块号，从而定位目录)
  
        <img src="E:\截图文件\线性检索法.png" style="zoom:67%;" />
  
      +  Hash方法
  
        1.  利用Hash法所有查找目录时，如果目录项是空的，则表示系统中无指定文件
        2.  如果目录项文件名与指定文件名向匹配，表示该目录项正是寻找的文件所对应的目录项，故可以从中找到该文件的物理地址。
        3.  如果目录表的相应目录项中文件名与指定文件名并不匹配，表示发生了冲突此时必须要使用Hash冲突处理方案(**线性探测**，**平方探测**，**再哈希**)的方法，获取新的目录位置，并比较。

#### 文件存储空间的管理

1.  空闲表法和空闲链表法

   +  空闲盘块映射表(需要给定第一块空闲盘块号以及空闲排块数)

     存储空间的分配与回收:

     空闲盘区的分配与内存的动态分配类似，同样时采用**首次适应算法**,**循环首次适应算法**。例如,系统为创建的文件分配空闲盘块时，先顺序检索空闲表的各个表项，直至找到第一个大小满足分配需求的空闲区域(再将盘区分配给用户)，同时修改空闲表信息。

     系统对用户释放空间进行回收时，页采取类似的内存回收方法，需要考虑到回收区域与空闲表查询点的前区，还是后区域，并对相邻区域进行合并(内存块合并).

   +  空闲链表法

     1.  空闲盘块链
     2.  空闲盘区链

2.  位示图法

   +  位示图

     <img src="E:\截图文件\位视图.png" style="zoom:67%;" />

   +  盘块的分配

     1.  顺序扫描位示图,从中找出一个或者一组其值为0的二进制为( 0 表示空闲)

     2.  将找到的一个或者一组二进制位，转换为与之对应的盘块号，假定找到的值为0的二进制位。位于位视图的第i行，第j列。则盘块号

        ​	b= n*(i-1) +j 

        其中n代表每行的位数

     3.  修改位示图 

        map[ i ,j ] =1

   +  盘块的回收

     1.  将回收盘块的盘块号转换为位示图的行号和列号，转换公式为:

        i = ( b - 1) DIV n+1

        j = ( b - 1 ) MOD n+1

     2.  修改位示图

        map[ i, j] =0

3.  成组链接法

   +  空闲盘块的组织

     <img src="E:\截图文件\空闲盘块组织.png" style="zoom:67%;" />

   +  空闲盘块的分配与回收

     1.  空闲盘块的分配

        当系统为用户分配文件所需的盘块时，须调用盘块分配过程来完成。该过程首先需要检查盘块号栈是否上锁。如果没有上锁，便从栈顶获取一个空闲盘块号，将与之对应的盘块分配给用户，分配完毕移动栈指针。

     2.  空闲盘块的回收

        系统回收盘块时，需要调用盘块回收过程进行回收，它是将回收盘块的盘块号记入盘块号栈的顶部，并上移栈指针。

#### 文件共享和文件保护

+  利用符号链实现文件共享

  利用符号链方式实现问阿金共享时，只有文件主才有指向索引结点的指针(只有文件主才能获取文件记录)。共享文件的用户，只拥有路径名称，并不拥有指向索引结点的指针。这样，就不会发生文件主删除文件，共享用户出现**悬空访问**的问题。

  当文件删除时，其他用户视图通过该文件访问失败，于是将符号链接删除，此时不会产生任何影响。

+  磁盘容错技术

  1.  通过存取控制机制来方式**人为因素**造成的文件不安全型
  2.  通过磁盘容错技术，防止**磁盘部分故障**造成的文件不安全性
  3.  通过**后备系统**防止有自然因素造成的不安全性。

  +  第一级容错技术SFT-I

    1.  双份目录和双份文件分配表

       在磁盘上存放文件目录和文件分配表FAT.是文件管理所用的重要数据结构，如果这些表格破坏，那么导致磁盘上部分或者全部文件都称为不可访问状态，等效于文件丢失。为了防止这类情况发生，可在不同磁盘上或在磁盘不同区域中，分别建立双份目录表和FAT，一份称作主目录及主FAT，另一个称为备份目录和备份FAT。

    2.  热修复重定向和写后读校验

       +  热修复重定向
       +  写后读校验

  + 第二级容错技术SFT-II

    1.  磁盘镜像

       <img src="E:\截图文件\磁盘镜像图示.png" style="zoom:67%;" />

    2.  磁盘双工

       <img src="E:\截图文件\磁盘双通道.png" style="zoom:67%;" />

#### 数据一致性控制

1.  事务

   +  事务的定义

     ```markdown
     事务是用于访问和修改各种数据项的一个程序单位。
     被访问的数据可以分散地存放在同一文件的不同记录中，也可放在多个文件中。只有对分布在不同位置的同一数据所进行的读和写(含修改)操作全部完成时，才能再以托付操作(Commit Operation)来终止事务。 
     只要有一个读、写或修改操作失败，便须执行夭折操作(Abort Operation)。读或写操作的失败可能是由于逻辑错误， 也可能是系统故障所导致的。 
     ```

   +  事务记录(Transaction Record)

     1.  事务名称	用于表示事务的唯一名称
     2.  数据项名    被修改数据项唯一名字
     3.  旧值            修改前数据项的值
     4.  新值            修改后数据项将具有的值

   +  恢复算法

     恢复算法可以利用如下两个过程

     1.  undo <T>  该过程将把被事务T修改过的时间恢复成修改前的值
     2.  redo <T> 该过程把事务T修改过的数据设置为新值

     如果发生系统故障，系统应对以前发生的所有事务进行清理。

2.  检查点

   +  检查点的作用

     引入检查点的主要目的，是使对事务记录表中事务记录的清理工作经常化，
     即每隔一定时间便做一次下述工作:

     1.  首先是将驻留在易失性存储器(内存)中的当前事务记录表中的所有记录，输出到稳定存储器中
     2.  其次是将驻留在易失性存储器中的所有已修改数据，输出到稳定存储器中
     3.  然后是将事务记录表中的〈检查点〉记录，输出到稳定存储器中
     4.  最后是每当出现一个〈检查点〉记录时，系统便执行上小节所介绍的恢复操作，利用redo和undo过程实现恢复功能。

   +  新的恢复算法

     ​		恢复例程首先查找事务记录表，确定在最近检查点以前开始执行的最后的事务Ti。在找到这样的事务后， 再返回去搜索事务记录表，便可找到第一个检查点记录，恢复例程便从该检查点开始，返回搜索各个事务的记录，并利用redo和undo过程对它们进行处理.

     ​       如果把所有在事务Ti以后开始执行的事务表示为事务集T， 则新的恢复操作要求是：对所有在T中的事务TK, 如果在事务记录表中出现了〈TK托付〉记录，则执行redo〈TK〉操作； 反之，如果在事务记录表中并未出现〈TK托付〉记录，则执行undo〈TK〉操作.

3.  并发控制

   +  利用互斥锁实现顺序性
   +  利用互斥锁和共享锁实现顺序性

4.  重复数据的一致性问题

   +  重复文件的一致性

     <img src="E:\截图文件\重复文件一致性.png" style="zoom:67%;" />

   +  盘块号一致性检查

     <img src="E:\截图文件\盘块号一致性.png" style="zoom:67%;" />

   +  链接数一致性检查

     ​	为每个盘块建立一个表项，其中含有该索引结点号的计数值。在进行检查时，从根目录开始查找，每当在目录中遇到该索引结点号时， 便在该计数器表中相应文件的表项上加1。当把所有目录都检查完后，便可将该计数器表中每个表项中的索引结点号计数值与该文件索引结点中的链接计数count值加以比较，如果两者一致，表示是正确的；否则，便是发生了链接数据不一致的错误。 