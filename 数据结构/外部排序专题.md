### **外部排序**

---

1. 外存信息的存储方式

   计算机分为两种存储器，**内存储器(主存)**和**外存储器(辅助存储)**。内部信息可以随机存储，且存取速度快。外存储器包括**磁带**和**磁盘**，磁带为顺序存取，**磁盘**为随机存储的设备。

   **磁带读写一块数据所需时间**:

   ​	T(IO)= t( a ) + n * t( w )

   ​	其中ta为延迟时间，为读写头到达传输信息所在物理块起始位置的时间。tw为传送一个字符的时间。 

   **磁盘信息的存取:**

   ​	在磁盘上读写一块信息主要有三个时间组成

   ​	T(IO)= t (seek) + t (ld)  + n* t (wm)

   ​	其中:

   ​		t(seek)为读写头定位的时间

   ​		t(ld)为等待时间，等待信息块初始位置旋转到读写头下的时间。

   ​		t(wm)为单个字符传送时间

   ​	由于磁盘旋转很快(2400/3600 r/min),所以等待时间最长不超过25ms，磁盘传输速率一般在10^5字符/秒，基本上读写时间花在寻找时间上。t(seek)。因此，在磁盘上存放信息时，应当将相关信息存放在同一柱面上或者临近柱面上，以求读写时尽量减少磁头来回移动的次数，减少不必要的巡查时间。

2. 外部排序的方法

   外部排序基本上由两个相对独立的部分组成。 

    1. 根据内存的大小，将外存上n个记录的文件分成若干个长度为l的**子文件**(也称作**段**)。依次读入内存，并利用有效的内部排序方法对其进行排序。并将排序好的有序子文件(**段**)重新写入到外存中。通常称这些子文件为**归并段**或**顺串**。

    2. 对**归并段**进行逐趟归并，使得归并段逐渐的由小到大，直至得到整个文件有序为止。这里主要讨论的是这个问题。

       外部排序总时间=内部排序时间(m*t(TS))+外存信息读写时间(d * t(IO)) +内部归并所需时间(s * ut(mg))

       其中t(IO)要远比ut(mg)大的多，所有改善性能时主要着眼于d的减小工作。

       对于同一个文件来说，进行外排时所需读写1外存的次数和归并趟数s成正比。对于一般情况下，对m个初始归并段进行k路平衡树，可以得到

       ​	归并次数	s=log(k,m)

3. 多路平衡归并的实现

   + 败者树的实现

     ```c++
     // 败者树的生产与调整
     
     ```

     在k路归并时使用败者树，可以使得在k个记录中获取最小关键字时仅需要进行log(2,k)次比较

     败者树: 双亲节点记下这场比赛的失败者(数小的)，使得胜利者进行下一轮比赛(层数更高)。

4. 置换-选择排序

   + 置换选择排序的基本步骤

     假设待排文件为输入文件**FI**,初始归并段文件输出文件**FO**，内存工作区为**WA**。，假设内存空间WA可以容纳w个记录。

     1. 从FI输入w个记录到达WA。
     2. 从WA使用败者树获得最小记录，记为MINIMAX。
     3. 将MINIMAX记录输出到FO中。
     4. 若FI不空,则FI输入下一个记录到WA中。
     5. 调整WA空间内部的败者树，选取出新的比MINIMAX大的最小记录作为新的MINIMAX
     6. 重复3-5直至选取不出新的最小记录位置，由此得到的记录为一个初始的归并段
     7. 重复2-6直至WA为空，阔的全部的初始归并段

     ```c++
     // 置换选择排序的实现
     ```

     置换选择排序获得的初始归并段的长度不等,当输入文件中记录的关键字为随机数时，所得到的归并段平均长度为内存工作区大小w的两倍。

     不考虑输入输出的时间，n个记录的文件，生成所有的初始归并段所需时间为O(nlog w)

5. 最佳归并树

   ​		若将初始归并段的长度看做时归并树中叶子节点的权，则不同的归并方案会导致不同的树带权路径长度和。那么按照点权去构造一颗赫夫曼树。可以使得外部归并时所需外存读写次数最少。这颗树就称作最佳归并树。

   ​	若是按照最佳归并树的递归方案在磁盘上进行归并排序，需要在内存中建立一张载有归并段长度与其在磁盘上物理位置的索引表。