1. **文件相关的基本概念**

   + 文件是由大量性质相同的记录组成的组合，可以按照性质分成**操作系统文件**和**数据库文件**

     操作系统中文件仅仅是一维的连续的字符序列，无结构，无解释。它也是记录的组合，这个记录指的是一个字符组，用户为了存取，加工方便，吧文件的信息划分给若干组，每一组信息称作一个逻辑记录。且可以按顺序编号。

     数据库文件是带有结构的记录集合，这类记录是由一个或者是多个数据项组成的集合。也是文件中可存取数据的基本单位。数据项是最基本的不可分的数据单位，也是文件中可使用的数据最小单位。

   + 文件按照记录的特性可以分为**定长记录文件**和**不定长记录文件**

   + 数据库文件中还可以根据关键字的数量分为**单关键字文件**和**多关键字文件**

   + 记录的逻辑结构和物理结构

     记录的物理存储结构指的是数据在物理存储器上的存储方式，是数据的物理表示和组织。

     记录的逻辑结构指的是记录在用户或者应用程序面前呈现的方式，是用户对数据的表示和存取方式。

   + 文件的相关操作

     1. 顺序存取

        存取下一个逻辑记录

     2. 直接存取

        存取第i个逻辑记录

     3. 按关键字存取

        给定一个值，查询一个或者是一批关键字与给定的值作比较。对数据库文件有如下4中查询方式:

        - 简单询问
        - 区域询问
        - 函数询问
        - 布尔询问

   + 文件的物理存储结构

     文件在存储介质上的组织方式称作文件的物理结构

     包括以下3种

     + 顺序组织
     + 随机组织
     + 链组织

2. 顺序文件

   顺序文件是指记录在其文件中的逻辑顺序依次进入存储介质而建立起来的，即顺序文件的物理记录的顺序与逻辑记录的顺序保持一致。若两个相邻的逻辑记录在物理位置上也是相邻的，则称作为**连续文件**。若这个顺序是由链相连接，则称为**串联文件**。

   顺序文件的特点:

   1. 存取第i个元素，必须要对前i-1个记录进行存取
   2. 插入新纪录时只能插入在文件的末尾
   3. 若要更新文件的某个记录时，则必须要对整个文件进行复制

   常用的顺序文件存储案例: **磁带**

   磁带文件批处理过程:

   	1. 待修改的原始文件作为主文件，放在一条词条上,所修改的请求集中构成一个文件，称作**事务文件**，并存放在另一台机器上，尚且需要三台磁带作为新的主文件的存储介质。
    	2. 主文件关键字自小至大顺序有序，事务文件必须和主文件有相同的有序关系。
    	3. 首先，对事务文件进行排序，然后将主文件和事务文件归并成一个新的主文件。在归并过程中，顺序读取出主文件和事务文件的记录,比较他们的关键字并进行处理。对于关键字不匹配与主文件的记录，直接写入到新的文件中。更新或者删除记录时，要求其关键字匹配，删除操作不需要将记录写入主文件。而更新操作需要将更新后的关键字写入到新的主文件中。插入操作不要求关键字匹配，直接将食物文件上需要插入的记录写到新的主文件合适的位置即可。

   有事务文件与主文件归并获得新的主文件的方法

   ```c++
   void MergeFile(File* f,File* g,File* h){
       // f为主文件，g为事务文件，h为新的主文件
   }
   ```

   分析上述批处理算法的时间复杂度，在一般情况下，事务文件的大小较小，可以直接进行内部排序。复杂度为O(mlog m),考虑到内部归并的时间复杂度，最终时间复杂度为O(mlog m+n)

3. 索引文件

   除了文件本身(数据区)之外,另建立一张指示逻辑记录和物理记录之间的关系(**索引表**)。此类文件包括数据区域和索引区域两个部分，称作**索引文件**

   索引表中的每一项称作**索引项**，无论主文件是否按照关键字有序，索引表的每一项都是按照关键字有序，索引表的每一项按照关键字顺序排列。若数据区的记录也按照关键字顺序排列，则称作**索引顺序**文件。否则叫做**索引非顺序**文件。

   索引表由系统程序自动生成，在记录输入数据区时同时建立一个索引表，其中索引项按记录输入先后顺序，等到全部信息输入之后，对索引表进行排序。

   索引文件的检索方式分为**直接存取**和**关键字存取**。

   	1. 从索引表中查找该记录，若有则直接读取外存中对应的记录，否则就表示没有，就可以不用去读取了。
    	2. 索引文件的修改也容易进行，即查询到相应信息，并对其做出修改。包括数据区的修改和索引表中索引项的修改。
    	3. 删除信息时，只需删除相应的索引项即可。
    	4. 插入记录时，只需要将数据插入到数据区的末尾，并在索引表中插入索引项。

   ​        若当记录数据量相当大时，索引表也很大，以至于一个物理块容纳不下。这种情况下查找索引仍旧要多次访问外部内存。因此，可以对索引表再次设定一个索引，这里称作为**查找表**。如果查找表中的记录数仍然很多，则需要建立包含当前查找表索引信息的高级查找表。整个检索过程为高级查找表->低级查找表->索引表->数据文件。这种多级索引称之为**静态索引**。各级索引均为顺序表结构，结构简单，但是不方便应对修改，因为重组索引很不方便。

   ​       考虑更好地对修改的支持，考虑使用**动态索引**(二叉排序树AVL,B-树,以及键树)。这样所插入删除就比较方便。由于树表结构本身就属于层次结构，所以无需建立多级索引，且建表过程即对索引排序的过程。当数据量不多时采用AVL树比较合适，算法的时间复杂度为TODO。

   ​		否则，当文件很大的时候索引表本身也处于外存中，那么查找索引需要多次访问外存，因此为了减少访问外存的次数，需要使得树表的层次尽量低。因此选择m阶的B-树作为索引表，m的选择取决于索引项的多少以及缓冲区的大小。考虑到一些特殊的关键字(有范围的)可以使用键树作为索引表结构，当索引项较少时，可以使用双链表结构(存储在内存)。否则需要使用Trie结构作为存储结构。

   ​	数据文件中记录不按照关键字进行顺序排列，则需要对每个记录建立起一个索引项，因此建立的索引表叫做**稠密索引。**否则叫做**非稠密索引**(关键字有序或者基本有序)。

4. ISAM/VSAM文件

   + ISAM文件(索引顺序文件)

     ​		是一种专门为磁盘设计的文件组织方式。由于磁盘是盘组，柱面，磁道三级存储到设备，因此可以对磁盘上的数据文件建立**盘组，柱面，磁道**三级索引。对于每个**磁道索引**项来说，通常有**基本索引项**和**溢出索引项**两部分组成。每个部分又包括关键字和指针两个部分，前者表示磁道中最后一个记录的关键字(这里指的是最大关键字)，后者表示的是该磁道中第一个记录的位置。**柱面索引**的每一个索引项也是由关键字和指针两部分组成，前者由柱面中的最后一个关键字，后者指的是该柱面上的磁道索引位置。柱面索引存放在某个柱面上，当柱面索引较大且占用了多个磁道的时候，则可以建立柱面索引的索引---**主索引**

     ​		在ISAM文件上检索记录时，先从主索引出发找到相应的柱面索引，再从柱面索引出发找打磁道索引，最后从磁道索引所指的第一个位置出发进行顺序查找直至找到位置。

     ​		每个柱面开辟了一个溢出区，并且磁道索引项中有溢出索引项，这是为了插入记录所设置的。由于ISAM文件中记录是按照关键字顺序存放的，则在插入记录时需要移动记录，并将同一磁道中最末一个元素移到溢出区，同时修改磁道索引。溢出区的设置可以分为如下几种:

     + 集中存放: 整个文件设置一个大的单一溢出区
     + 分散存放: 每个柱面设置一个溢出区
     + 集中与分散相结合: 溢出时先移动到每个柱面各自的溢出区，待满之后移动到公共溢出区

     

     ​		每个柱面基本区时顺序存储结构，溢出区为链表结构。同一磁道溢出的结构由指针相连，该磁道索引溢出索引项中的关键字指向磁道溢出记录的最大关键字，而指针指向溢出区第一条记录。

     ​		删除记录时只需要找到待删除的记录，在其存储位置上做标记即可，不需要移动记录或者是改变指针。由于文件的多次增删操作，文件结构发生了很大的变化，大量的记录进入了溢出区，基本区文件存在有很多的空间区域，因此需要周期性的清理ISAM文件。(把记录读入内存，重新排列,复制成一个新的ISAM文件，填满基本区清空溢出区)

   + VSAM文件 (虚拟存储存取方法)

     利用了操作系统虚拟存储器的功能，给用户提供方便。对用户来说，文件只存在有控制区和控制区域等逻辑存储单元。与外存储器中的柱面磁道等具体的存储单位没有必然的联系。用户在具体存储文件的记录时，不需要考虑这个记录的当前位置是否在内存，也不需要考虑何时对外存进行读写指令。

     VSAM文件包括三部分:  **索引集**，**顺序集**，**数据集**

     文件记录都存储在数据集中，数据集中的一个节点称作为**控制区间**，它是一个IO的基本操作单位，有一组连续的存储单元组成。控制区间的大小随着文件不同而不同。但是同一个文件的控制区间大小相同，每个控制区间含有一个或是多个关键字顺序排列。

     顺序集和索引集构成一颗B+树，作为文件的索引部分。顺序集存放每个控制区间的索引项，每个控制区间的索引项包含两个部分，一是该控制区域的最大关键字，二是指向这个控制区间的指针。若干相邻区域的索引项形成顺序集中的一个**节点**(B+树节点)，节点之间使用链相连。而每个节点又在。上一层中设置有索引，逐层向上建立索引。所有的索引项都有最大关键字和指针两部分组成。

     因此VSAM文件既可以在顺序集中进行集中的顺序存取，也可以从B+树根节点开始按照关键字进行存取。顺序集中一个节点连同其对应所有的控制区间形成一个整体，称作**控制区域**。每个控制区间可以视为一个逻辑磁道，而每一个控制区域可以视为一个逻辑柱面。

     + VSAM文件记录的增删改查

     1. VSAM文件没有设置溢出区，解决插入的方法是在初始文件时留有空间。
     2. 删除记录时，需要将统一控制区间中较删除记录关键字大的记录向前移动，把空间留给以后插入的新纪录。若整个控制区间变空，则需要修改顺序集中相应的索引项。

5. 直接存储文件(散列文件)

   利用杂凑(Hash)法进行组织的文件。类似于哈希表，故又称散列文件。

   与哈希表不同的是，磁盘上的文件记录通常是成组存放的，若干个记录存储为一个存储单元，在散列文件中这个存储单元叫做**桶**。假如一个桶能存放m个记录，即存放m个同义词不会发生溢出，而当存入m+1个记录时会溢出。对于散列文件通常采用**链地址法**。

   优点： 文件随机存放，不需要经过排序，插入删除方便，存取速度块，不需要建立索引，节省存储空间。

   缺点:   不能进行顺序存取，只能按照关键字进行随机存取，且询问方式仅限于简单询问。且多次增删之后会导致文件结构的不合理(桶满溢出较多,但是基本桶内删除的记录较多)，需要对文件重组。

6. 多关键字文件

   特点： 对文件进行检索时，不仅对主关键字进行简单询问，还需要对次关键字进行其他类型的询问检索。

   + **多重表文件**

     按主关键字的顺序构成一个串联文件，并建立起主关键字的索引，对每个次关键字建立次关键字索引。所有具有同一次关键字的记录构成一个链表。

     主关键字为非稠密索引，次关键字为稠密索引。

     每个索引包含次关键字，头指针和链表长度。

   + **倒排文件**

     倒排文件与多重表文件区别在于次关键字索引结构不同，通常次关键字索引为**倒排表**，具有相同次关键字的记录之间不设指针相连，在倒排表中次关键字存放这些记录的**物理记录号**。

     倒排表的好处在于检索记录较快。

     + 插入和删除记录时，倒排表要做出相应的修改，值得注意的时倒排表中具有同一次关键字的记录号是有序排列的。
     + 数据文件不是串链文件，而是ISAM则倒排表中存放记录的主关键字而不是物理记录号。

   